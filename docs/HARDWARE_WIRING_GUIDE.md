# SmartDesk 硬件连接指南

## 🔌 硬件接线总览图

```
┌──────────────────────────────────────────────────────────────────┐
│                    STM32F407VET6 主控板                           │
│                   (Black Pill / WeAct Core)                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  I2C 总线                                                         │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PB6 (SCL) ──────→ [OLED SSD1315] ← SCL                       │
│  │ PB7 (SDA) ──────→ [OLED SSD1315] ← SDA                       │
│  │ GND ────────────→ [OLED] ← GND                               │
│  │ 3.3V ──────────→ [OLED] ← VCC                                │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
│  UART2 (ASRPRO 语音模块)                                         │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PA2 (TX) ──────→ [ASRPRO] ← RX                               │
│  │ PA3 (RX) ◄──── [ASRPRO] ← TX                                 │
│  │ GND ────────────→ [ASRPRO] ← GND                             │
│  │ 5V (降压至3.3V) → [ASRPRO] ← VCC                             │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
│  UART3 (ESP8266-01S WiFi模块)                                   │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PB10 (TX) ─────→ [ESP8266] ← RX                              │
│  │ PB11 (RX) ◄──── [ESP8266] ← TX                               │
│  │ GND ────────────→ [ESP8266] ← GND                            │
│  │ 3.3V (独立) ───→ [ESP8266] ← VCC                             │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
│  GPIO - DHT11 (传感器)                                           │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PA1 ──────────→ [DHT11] ← DATA                               │
│  │ GND ──────────→ [DHT11] ← GND                                │
│  │ 3.3V ────────→ [DHT11] ← VCC                                 │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
│  PWM - Servo Head (PA0)                                         │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PA0 (PWM) ─────→ [SG90 Servo1] ← Signal                      │
│  │ GND ─────────→ [SG90 Servo1] ← GND                           │
│  │ 5V (独立) ──→ [SG90 Servo1] ← VCC                            │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
│  PWM - Servo Nod (PA5)                                          │
│  ┌─────────────────────────────────────────────────────────────┤
│  │ PA5 (PWM) ─────→ [SG90 Servo2] ← Signal                      │
│  │ GND ─────────→ [SG90 Servo2] ← GND                           │
│  │ 5V (独立) ──→ [SG90 Servo2] ← VCC                            │
│  └─────────────────────────────────────────────────────────────┤
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📋 逐模块接线详解

### 1. OLED 显示屏 (SSD1315)

**模块规格**: 0.96寸OLED，I2C接口，分辨率128x64

**接线方式**:

| OLED引脚 | STM32引脚 | 信号 | 说明 |
|---------|----------|------|------|
| GND | GND | Ground | 地线 |
| VCC | 3.3V | Power | 电源(3.3V) |
| SCL | PB6 | I2C时钟 | 时钟线 |
| SDA | PB7 | I2C数据 | 数据线 |

**接线图**:
```
OLED:
  GND ────→ STM32 GND
  VCC ────→ STM32 3.3V
  SCL ────→ STM32 PB6
  SDA ────→ STM32 PB7
```

**I2C地址**: 0x3C

**初始化代码** (config.h):
```cpp
#define OLED_SDA PB7
#define OLED_SCL PB6
#define OLED_I2C_ADDR 0x3C
```

---

### 2. DHT11 温湿度传感器

**模块规格**: 单线数字输出，精度±2°C/±5%RH

**接线方式**:

| DHT引脚 | STM32引脚 | 信号 | 说明 |
|--------|----------|------|------|
| GND | GND | Ground | 地线 |
| VCC | 3.3V | Power | 电源(3.3V) |
| DATA | PA1 | 数据 | 单线数据 |

**接线图**:
```
DHT11:
  GND ────→ STM32 GND
  VCC ────→ STM32 3.3V
  DATA ───→ STM32 PA1
```

**初始化代码** (config.h):
```cpp
#define DHT_PIN PA1
#define DHT_TYPE DHT11
```

---

### 3. ASRPRO 语音识别模块

**模块规格**: UART通信，9600波特率，离线识别

**接线方式**:

| ASRPRO引脚 | STM32引脚 | 信号 | 说明 |
|-----------|----------|------|------|
| GND | GND | Ground | 地线 |
| VCC | 5V+降压 | Power | 需要5V+降压至3.3V |
| TX | PA3 | UART RX | 接收数据 |
| RX | PA2 | UART TX | 发送数据 |

**接线图**:
```
ASRPRO (Serial2):
  GND ────→ STM32 GND
  VCC ────→ 5V电源(需降压至3.3V)
  TX ─────→ STM32 PA3
  RX ─────→ STM32 PA2
```

**注意**: ASRPRO需要5V供电，但TX/RX信号需要降至3.3V！

**初始化代码** (config.h):
```cpp
#define UART_ASRPRO Serial2
#define UART_BAUD_ASRPRO 9600
```

**电路保护**:
```
推荐使用分压电阻 (或TTL转换模块):
  ASRPRO TX (5V) ──[10k]──→ 中点 ──[20k]──→ GND
  中点 ────────→ PA3
```

---

### 4. ESP8266-01S WiFi模块

**模块规格**: UART通信，115200波特率，支持WiFi

**接线方式**:

| ESP8266引脚 | STM32引脚 | 信号 | 说明 |
|-----------|----------|------|------|
| GND | GND | Ground | 地线 |
| VCC | 3.3V独立 | Power | 3.3V独立供电(最小500mA) |
| TX | PB11 | UART RX | 接收数据 |
| RX | PB10 | UART TX | 发送数据 |
| CH_PD | 3.3V | 芯片使能 | 接3.3V使能 |
| RST | 3.3V | 复位 | 接3.3V(可选复位电路) |

**接线图**:
```
ESP8266-01S (Serial3):
  GND ────→ STM32 GND
  VCC ────→ 3.3V独立电源(最少500mA)
  TX ─────→ STM32 PB11
  RX ─────→ STM32 PB10
  CH_PD ──→ 3.3V
  RST ────→ 3.3V (可选)
```

**电源要求**: 
- 需要独立的3.3V电源供应
- 最小电流500mA，建议1A以上
- 使用大容量滤波电容 (100uF)

**初始化代码** (config.h):
```cpp
#define UART_ESP8266 Serial3
#define UART_BAUD_ESP8266 115200
```

---

### 5. SG90 舵机1 - 头部水平 (PA0)

**模块规格**: 180度旋转，PWM控制

**接线方式**:

| 舵机引脚 | 含义 | 连接 | 说明 |
|--------|------|------|------|
| 棕色 | GND | GND | 地线 |
| 红色 | VCC | 5V电源 | 电源(5V) |
| 橙色 | Signal | PA0 | PWM信号 |

**接线图**:
```
SG90 Servo1 (摇头):
  棕色 (GND) ────→ STM32 GND (需要共地)
  红色 (VCC) ────→ 5V电源(独立,最小1-2A)
  橙色 (Signal) ─→ STM32 PA0
```

**初始化代码** (config.h):
```cpp
#define SERVO_HEAD_PIN PA0
```

**PWM参数**:
- 频率: 50Hz
- 脉宽: 1-2ms
- 角度: 0-180度

---

### 6. SG90 舵机2 - 头部垂直 (PA5)

**模块规格**: 180度旋转，PWM控制

**接线方式**:

| 舵机引脚 | 含义 | 连接 | 说明 |
|--------|------|------|------|
| 棕色 | GND | GND | 地线 |
| 红色 | VCC | 5V电源 | 电源(5V) |
| 橙色 | Signal | PA5 | PWM信号 |

**接线图**:
```
SG90 Servo2 (点头):
  棕色 (GND) ────→ STM32 GND (需要共地)
  红色 (VCC) ────→ 5V电源(独立,最小1-2A)
  橙色 (Signal) ─→ STM32 PA5
```

**初始化代码** (config.h):
```cpp
#define SERVO_NOD_PIN PA5
```

---

## 🔋 电源配置

### 电源需求总结

```
STM32F407VET6 系统:
  ├─ 主控 3.3V: ~500mA
  ├─ OLED: ~50mA @ 3.3V
  ├─ DHT11: ~10mA @ 3.3V
  ├─ ASRPRO: ~200mA @ 5V (降压至3.3V logic)
  ├─ ESP8266: ~500mA @ 3.3V (独立)
  ├─ Servo1: 1-2A @ 5V (独立)
  └─ Servo2: 1-2A @ 5V (独立)

总计:
  3.3V系统: ~560mA (连续), 1A+ (峰值)
  5V系统: 4-5A (峰值) / 1-2A (平均)
```

### 推荐电源方案

#### 方案1: USB供电 (开发调试)

```
USB 5V ─→ [5V LDO] ──→ ASRPRO (5V)
         │
         ├─→ [3.3V LDO] ──→ STM32 + 传感器 + OLED
         │
         └─→ GND (共地)

舵机: 需要额外的5V供电 (推荐1-2A)
ESP8266: 需要额外的3.3V供电 (推荐500mA)
```

#### 方案2: 独立电源 (生产应用)

```
主电源 (5V/3A):
  ├─→ ASRPRO (5V直接)
  ├─→ Servo1 (5V直接)
  ├─→ Servo2 (5V直接)
  └─→ [LDO] ──→ STM32 + OLED + DHT11 (3.3V)

WiFi电源 (3.3V/1A):
  └─→ ESP8266 (3.3V)

USB电源 (5V/1A):
  └─→ STM32 调试器 (可选)
```

### 关键要点

⚠️ **电源共地**: 所有模块GND必须连接到STM32的GND  
⚠️ **独立供电**: 舵机、ESP8266、ASRPRO需要独立电源  
⚠️ **滤波电容**: 每个电源应添加100uF电解电容  
⚠️ **信号隔离**: ASRPRO的5V信号需要分压至3.3V  

---

## 🧪 接线验证检查清单

### I2C验证
- [ ] OLED SCL连接PB6
- [ ] OLED SDA连接PB7
- [ ] OLED GND和3.3V正确
- [ ] 地线连接完整

### UART2 (ASRPRO) 验证
- [ ] PA2连接ASRPRO TX
- [ ] PA3连接ASRPRO RX
- [ ] GND连接正确
- [ ] 5V电源经过降压
- [ ] 信号线经过分压(3.3V)

### UART3 (ESP8266) 验证
- [ ] PB10连接ESP8266 TX
- [ ] PB11连接ESP8266 RX
- [ ] GND连接正确
- [ ] 3.3V独立供电
- [ ] CH_PD连接3.3V

### GPIO (DHT11) 验证
- [ ] PA1连接DHT DATA
- [ ] GND连接正确
- [ ] 3.3V连接正确
- [ ] 可选: DATA线添加上拉电阻(4.7k)

### PWM验证
- [ ] PA0连接Servo1信号
- [ ] PA5连接Servo2信号
- [ ] 舵机GND连接正确
- [ ] 舵机5V独立供电
- [ ] 所有GND共地

### 全局验证
- [ ] 所有GND点连接完整
- [ ] 所有电源电压正确
- [ ] 无短路迹象
- [ ] 无接线混乱

---

## 💾 配置文件验证

检查 `include/config.h` 中的所有定义:

```cpp
// ✅ I2C
#define OLED_SDA PB7
#define OLED_SCL PB6
#define OLED_I2C_ADDR 0x3C

// ✅ GPIO
#define DHT_PIN PA1
#define SERVO_HEAD_PIN PA0
#define SERVO_NOD_PIN PA5

// ✅ UART
#define UART_ASRPRO Serial2
#define UART_ESP8266 Serial3
#define UART_BAUD_ASRPRO 9600
#define UART_BAUD_ESP8266 115200
```

---

## 🚨 常见接线错误

| 错误 | 后果 | 解决方案 |
|------|------|--------|
| I2C引脚反向 | OLED无显示 | 检查PB6/PB7 |
| UART波特率错误 | 通信乱码 | ASRPRO=9600, ESP8266=115200 |
| GND未共地 | 信号异常 | 连接所有GND到STM32 |
| 电源反接 | 芯片烧毁 | 三思而行 |
| 5V信号直接接3.3V | GPIO损坏 | 使用分压或转换模块 |

---

## ✅ 接线完成检查

**所有引脚**: ✅ 已验证  
**所有电源**: ✅ 已验证  
**无冲突**: ✅ 已验证  
**波特率**: ✅ 正确  
**地线连接**: ✅ 完整  

**硬件接线**: 🟢 **就绪**

---

**最后更新**: 2026年2月5日  
**状态**: ✅ **硬件接线完成**
