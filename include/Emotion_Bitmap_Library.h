#ifndef EMOTION_BITMAP_LIBRARY_H
#define EMOTION_BITMAP_LIBRARY_H

#include <Arduino.h>
#include <U8g2lib.h>
#include "config.h"

/**
 * 表情库：使用像素阵列为OLED显示各种表情
 * 分辨率：32x32像素的表情，16x16像素的符号
 * 存储方式：PROGMEM（闪存存储）以节省RAM
 */

// 表情状态
enum class EmotionState {
    HAPPY = 0,
    SAD = 1,
    ANGRY = 2,
    CONFUSED = 3,
    HOT_WARNING = 4,
    COLD_WARNING = 5,
    SLEEPY = 6,
    ALERT = 7
};

// ==================== 32x32像素表情 ====================

// 快乐表情 (HAPPY) - 大嘴笑脸
static const uint8_t PROGMEM BITMAP_HAPPY[] = {
    0x00, 0x00, 0x00, 0x00,  // 行 1
    0x00, 0x3C, 0x3C, 0x00,  // 行 2-5：顶部空间
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,
    0x03, 0x00, 0x00, 0xC0,  // 行 6-9：眼睛
    0x06, 0x00, 0x00, 0x60,
    0x0C, 0x18, 0x18, 0x30,
    0x18, 0x18, 0x18, 0x18,
    0x30, 0x00, 0x00, 0x0C,  // 行 10-13：鼻子与嘴
    0x30, 0x00, 0x00, 0x0C,
    0x30, 0x3C, 0x3C, 0x0C,
    0x18, 0x7E, 0x7E, 0x18,
    0x0C, 0xFF, 0xFF, 0x30,  // 行 14-17：大笑嘴
    0x06, 0xFF, 0xFF, 0x60,
    0x03, 0xFE, 0xFE, 0xC0,
    0x01, 0xFC, 0xFC, 0x80,
    0x00, 0xF8, 0xF8, 0x00,  // 行 18-21
    0x00, 0x70, 0x70, 0x00,
    0x00, 0x20, 0x20, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 伤心表情 (SAD) - 哭泣的脸
static const uint8_t PROGMEM BITMAP_SAD[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,
    0x03, 0x00, 0x00, 0xC0,  // 眼睛（向下）
    0x06, 0x18, 0x18, 0x60,
    0x0C, 0x3C, 0x3C, 0x30,
    0x18, 0x3C, 0x3C, 0x18,
    0x30, 0x18, 0x18, 0x0C,  // 泪珠
    0x30, 0x0C, 0x0C, 0x0C,
    0x30, 0x06, 0x06, 0x0C,
    0x18, 0x00, 0x00, 0x18,
    0x0C, 0x7E, 0x7E, 0x30,  // 倒下的嘴
    0x06, 0xFF, 0xFF, 0x60,
    0x03, 0xFF, 0xFF, 0xC0,
    0x01, 0xFE, 0xFE, 0x80,
    0x00, 0xF0, 0xF0, 0x00,
    0x00, 0x60, 0x60, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 生气表情 (ANGRY) - 眉毛向下、嘴巴紧闭
static const uint8_t PROGMEM BITMAP_ANGRY[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,  // 愤怒眉毛
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0xFF, 0xFF, 0x80,
    0x03, 0xFF, 0xFF, 0xC0,  // 瞪大的眼睛
    0x06, 0xFF, 0xFF, 0x60,
    0x0C, 0xC0, 0xC0, 0x30,
    0x18, 0x00, 0x00, 0x18,
    0x30, 0x00, 0x00, 0x0C,
    0x30, 0x00, 0x00, 0x0C,
    0x30, 0x00, 0x00, 0x0C,
    0x18, 0x00, 0x00, 0x18,
    0x0C, 0x18, 0x18, 0x30,  // 紧闭嘴巴
    0x06, 0x3C, 0x3C, 0x60,
    0x03, 0x7E, 0x7E, 0xC0,
    0x01, 0xFC, 0xFC, 0x80,
    0x00, 0xF8, 0xF8, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 困惑表情 (CONFUSED) - 歪头、问号
static const uint8_t PROGMEM BITMAP_CONFUSED[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x1C, 0x38, 0x00,
    0x00, 0x38, 0x70, 0x00,  // 歪头
    0x00, 0x70, 0x60, 0x00,
    0x00, 0xE0, 0xC0, 0x00,
    0x01, 0xC0, 0x80, 0x00,  // 歪斜的眼睛
    0x03, 0x80, 0x00, 0x00,
    0x07, 0x00, 0x00, 0x00,
    0x0E, 0x00, 0x00, 0x00,
    0x1C, 0x00, 0x00, 0x00,  // 问号形状的嘴
    0x38, 0x00, 0x00, 0x00,
    0x30, 0x00, 0x00, 0x00,
    0x30, 0x18, 0x18, 0x00,
    0x30, 0x3C, 0x3C, 0x00,
    0x18, 0x3C, 0x3C, 0x00,
    0x0C, 0x18, 0x18, 0x00,
    0x06, 0x00, 0x00, 0x00,
    0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 热表情 (HOT) - 流汗的脸
static const uint8_t PROGMEM BITMAP_HOT[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,
    0x03, 0x00, 0x00, 0xC0,  // 紧张的眼睛
    0x06, 0x18, 0x18, 0x60,
    0x0C, 0x3C, 0x3C, 0x30,
    0x18, 0x7E, 0x7E, 0x18,
    0x30, 0xE0, 0x07, 0x0C,  // 张大嘴
    0x30, 0xC0, 0x03, 0x0C,
    0x30, 0x80, 0x01, 0x0C,  // 流汗
    0x18, 0x00, 0x00, 0x18,
    0x0C, 0x60, 0x60, 0x30,
    0x06, 0x70, 0x70, 0x60,
    0x03, 0x78, 0x78, 0xC0,
    0x01, 0x3C, 0x3C, 0x80,
    0x00, 0x18, 0x18, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 冷表情 (COLD) - 发抖的脸
static const uint8_t PROGMEM BITMAP_COLD[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,  // 发抖的身体
    0x03, 0x00, 0x00, 0xC0,
    0x06, 0x18, 0x18, 0x60,
    0x0C, 0x3C, 0x3C, 0x30,
    0x18, 0x3C, 0x3C, 0x18,
    0x30, 0x18, 0x18, 0x0C,  // 打哆嗦的嘴
    0x30, 0x3C, 0x3C, 0x0C,
    0x30, 0x66, 0x66, 0x0C,
    0x18, 0x66, 0x66, 0x18,
    0x0C, 0x3C, 0x3C, 0x30,
    0x06, 0x18, 0x18, 0x60,
    0x03, 0x00, 0x00, 0xC0,
    0x01, 0x80, 0x01, 0x80,
    0x00, 0xC0, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 困倦表情 (SLEEPY) - 闭眼的脸
static const uint8_t PROGMEM BITMAP_SLEEPY[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,
    0x03, 0xFF, 0xFF, 0xC0,  // 闭上的眼睛
    0x06, 0xFF, 0xFF, 0x60,
    0x0C, 0x7E, 0x7E, 0x30,
    0x18, 0x3C, 0x3C, 0x18,
    0x30, 0x18, 0x18, 0x0C,  // 小小的嘴
    0x30, 0x00, 0x00, 0x0C,
    0x30, 0x18, 0x18, 0x0C,
    0x18, 0x3C, 0x3C, 0x18,
    0x0C, 0x3C, 0x3C, 0x30,
    0x06, 0x18, 0x18, 0x60,
    0x03, 0x00, 0x00, 0xC0,
    0x01, 0x80, 0x01, 0x80,
    0x00, 0xC0, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// 警告表情 (ALERT) - 惊讶的脸
static const uint8_t PROGMEM BITMAP_ALERT[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x3C, 0x3C, 0x00,
    0x00, 0x66, 0x66, 0x00,
    0x00, 0xC3, 0xC3, 0x00,
    0x01, 0x81, 0x81, 0x80,
    0x03, 0xFF, 0xFF, 0xC0,  // 圆形的大眼睛
    0x06, 0xFF, 0xFF, 0x60,
    0x0C, 0xC0, 0x00, 0x30,
    0x18, 0x00, 0x00, 0x18,
    0x30, 0x00, 0x00, 0x0C,  // O形的嘴
    0x30, 0x18, 0x18, 0x0C,
    0x30, 0x3C, 0x3C, 0x0C,
    0x18, 0x7E, 0x7E, 0x18,
    0x0C, 0xFF, 0xFF, 0x30,
    0x06, 0xFF, 0xFF, 0x60,
    0x03, 0xFE, 0xFE, 0xC0,
    0x01, 0xFC, 0xFC, 0x80,
    0x00, 0xF8, 0xF8, 0x00,
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

// ==================== 16x16像素符号 ====================

// 心形 (HEART)
static const uint8_t PROGMEM BITMAP_HEART[] = {
    0x0F, 0xF0,  // 行 1-2：顶部弧形
    0x3F, 0xFC,
    0x7F, 0xFE,  // 行 3-4
    0xFF, 0xFF,
    0xFF, 0xFF,  // 行 5-6
    0xFF, 0xFF,
    0x7F, 0xFE,  // 行 7-8：尖端
    0x3F, 0xFC,
    0x1F, 0xF8,  // 行 9-10
    0x0F, 0xF0,
    0x07, 0xE0,  // 行 11-12
    0x03, 0xC0,
    0x01, 0x80,  // 行 13-14
    0x00, 0x00,
    0x00, 0x00,
    0x00, 0x00
};

// 太阳 (SUN)
static const uint8_t PROGMEM BITMAP_SUN[] = {
    0x00, 0x00,
    0x03, 0xC0,  // 行 1-2：上方光线
    0x03, 0xC0,
    0x03, 0xC0,  // 行 3-4
    0xFF, 0xFF,
    0xFF, 0xFF,  // 行 5-6：太阳圆盘
    0x0F, 0xF0,
    0x0F, 0xF0,  // 行 7-8
    0x0F, 0xF0,
    0xFF, 0xFF,  // 行 9-10
    0xFF, 0xFF,
    0x03, 0xC0,  // 行 11-12：下方光线
    0x03, 0xC0,
    0x03, 0xC0,  // 行 13-14
    0x00, 0x00,
    0x00, 0x00
};

// 云 (CLOUD)
static const uint8_t PROGMEM BITMAP_CLOUD[] = {
    0x00, 0x00,
    0x00, 0x00,  // 行 1-2
    0x01, 0xE0,  // 行 3-4：云的形状
    0x07, 0xF0,
    0x0F, 0xF8,  // 行 5-6
    0x1F, 0xFC,
    0x3F, 0xFE,  // 行 7-8
    0x3F, 0xFE,
    0x1F, 0xFC,  // 行 9-10
    0x0F, 0xF8,
    0x07, 0xF0,  // 行 11-12
    0x01, 0xE0,
    0x00, 0x00,  // 行 13-14
    0x00, 0x00,
    0x00, 0x00,
    0x00, 0x00
};

// 下雨 (RAIN)
static const uint8_t PROGMEM BITMAP_RAIN[] = {
    0x00, 0x00,
    0x01, 0xE0,  // 行 1-2：云
    0x07, 0xF0,
    0x0F, 0xF8,  // 行 3-4
    0x1F, 0xFC,
    0x3F, 0xFE,  // 行 5-6
    0x3F, 0xFE,
    0x1F, 0xFC,  // 行 7-8
    0x0F, 0xF8,
    0x06, 0x60,  // 行 9-10：雨滴
    0x06, 0x60,
    0x03, 0x30,  // 行 11-12
    0x03, 0x30,
    0x01, 0x80,  // 行 13-14
    0x00, 0x00,
    0x00, 0x00
};

/**
 * 表情位图库
 */
class EmotionBitmapLibrary {
private:
    U8G2* display;
    
public:
    EmotionBitmapLibrary() : display(nullptr) {}
    
    /**
     * 初始化库
     */
    void begin(U8G2* disp) {
        display = disp;
    }
    
    /**
     * 绘制表情（32x32）
     */
    void drawEmotion(EmotionState emotion, uint16_t x, uint16_t y) {
        if (display == nullptr) return;
        
        const uint8_t* bitmap = nullptr;
        uint16_t width = 32;
        uint16_t height = 32;
        
        switch (emotion) {
            case EmotionState::HAPPY:
                bitmap = BITMAP_HAPPY;
                break;
            case EmotionState::SAD:
                bitmap = BITMAP_SAD;
                break;
            case EmotionState::ANGRY:
                bitmap = BITMAP_ANGRY;
                break;
            case EmotionState::CONFUSED:
                bitmap = BITMAP_CONFUSED;
                break;
            case EmotionState::HOT_WARNING:
                bitmap = BITMAP_HOT;
                break;
            case EmotionState::COLD_WARNING:
                bitmap = BITMAP_COLD;
                break;
            case EmotionState::SLEEPY:
                bitmap = BITMAP_SLEEPY;
                break;
            case EmotionState::ALERT:
                bitmap = BITMAP_ALERT;
                break;
            default:
                return;
        }
        
        if (bitmap != nullptr) {
            display->drawBitmap(x, y, width / 8, height, bitmap);
        }
    }
    
    /**
     * 绘制符号（16x16）
     */
    void drawSymbol(const char* symbolName, uint16_t x, uint16_t y) {
        if (display == nullptr) return;
        
        const uint8_t* bitmap = nullptr;
        uint16_t width = 16;
        uint16_t height = 16;
        
        if (strcmp(symbolName, "heart") == 0) {
            bitmap = BITMAP_HEART;
        } else if (strcmp(symbolName, "sun") == 0) {
            bitmap = BITMAP_SUN;
        } else if (strcmp(symbolName, "cloud") == 0) {
            bitmap = BITMAP_CLOUD;
        } else if (strcmp(symbolName, "rain") == 0) {
            bitmap = BITMAP_RAIN;
        }
        
        if (bitmap != nullptr) {
            display->drawBitmap(x, y, width / 8, height, bitmap);
        }
    }
    
    /**
     * 绘制表情并添加滤镜
     */
    void drawEmotionWithEffect(EmotionState emotion, uint16_t x, uint16_t y, bool invert = false) {
        if (invert) {
            // 反色效果
            display->setDrawColor(0);
            display->drawBox(x - 2, y - 2, 36, 36);
            display->setDrawColor(1);
        }
        
        drawEmotion(emotion, x, y);
        
        if (invert) {
            display->setDrawColor(1);
        }
    }
};

#endif
